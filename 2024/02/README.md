# 2024.02.07 TIL

---

# Docker exec & attach
## attach
`attach` 명령어는 컨테이너의 표준 입력, 출력, 오류 스트림을 로컬 터미널과 연결해주는 명령어이다. 좀 더 자세히 설명하자면 해당 명령어를 사용하여 실행 중인 컨테이너에 연결하면 해당 컨테이너의 프로세스에 현재 터미널 세션을 연결한다. **이것은 기존 세션에 대한 새로운 세션을 열지 않고 현재 세션을 사용하여 컨테이너의 상태를 모니터링하고 제어하는 것을 의미**한다.

우선 테스트를 위해 ubuntu 운영체제만 받아와보자
```
docker run ubuntu 
```
<p align="center">
<img src=https://velog.velcdn.com/images/chlrjs132/post/a7c475c5-239c-4e6f-9f9c-955d07508ab3/image.png width="75%">
</p>

그런데 ubuntu 컨테이너가 실행되지 않고 바로 종료되었다. 왜그런걸까??

> **컨테이너를 실행할 때 실행될 명령이나 프로세스가 없다면 -d 옵션을 사용하더라도 즉시 종료될 것이다.** 나는 OS만 내려받았기 때문에 실행될 프로그램이 없을 것이고, 그렇다면 실행하자마자 컨테이너가 죽을 것이기 때문에 -it 옵션을 사용해 ubuntu 컨테이너를 터미널 모드로 실행시킬 시 bash가 실행될 것이다.

이번엔 `-dit`옵션을 사용해 ubuntu를 실행시켜보자
<p align="center">
<img src=https://velog.velcdn.com/images/chlrjs132/post/224d9b35-3d4b-4546-ac76-47081ea961d7/image.png width="80%">
</p>
컨테이너가 잘 살아있다.

현재 실행되고 있는 ubuntu 컨테이너에 attach 명령어를 사용해 bash를 사용할 수 있다.
![](https://velog.velcdn.com/images/chlrjs132/post/9e900c84-b0b9-41ab-9104-b5efe1d77cf2/image.png)

attach를 사용해 bash에 접근해 프로그램을 제어할 수 있다. 하지만 attach는 현재 세션을 유지한 채 접근하기 때문에 exit 명령어를 사용시 프로세스가 종료되어 컨테이너가 종료되는 것을 볼 수 있다.<br><br>

이번엔 apache 웹서버를 받아보자.
![](https://velog.velcdn.com/images/chlrjs132/post/909b5de3-a52a-4910-b67e-14af21e5cdde/image.png)

OS만 받아왔던 이전 상황과는 달리 OS와 apache 웹서버 프로그램이 실행 중이라 run을 해도 컨테이너가 계속 돌고 있다.

그러면 현재 실행 중인 컨테이너에 attach로 접근하면 어떻게 될까?
![](https://velog.velcdn.com/images/chlrjs132/post/790cf87a-43fe-4b46-8ad0-b9ddfb34cfab/image.png)

아무런 입출력도 제공되지 않고 있는 상황이다. ctrl + c로 빠져나오니 컨테이너가 종료되어버린다. 그렇다면 `-dit`옵션을 사용해 터미널 모드로 컨테이너를 실행시키면 어떻게 될까??
![](https://velog.velcdn.com/images/chlrjs132/post/e3fe3dfc-f72c-4dbe-a8ae-45393885ef64/image.png)

`-dit`옵션으로 실행된 컨테이너에 attach 명령어를 사용해 접근하니 컨테이너가 바로 꺼져버린다... 왜그런걸까?? 일단 이 문제는 뒤로 넣어두고 해당 상황 즉, 웹서버를 실행시키는 컨테이너 내부에서 터미널 접근을 하는 방법을 알아보자.

## exec
`exec` 명령어는 실행 중인 컨테이너에 특정 명령을 실행시키는 명령어이다. 이 명령어를 사용하면 기존 세션은 유지한 채 새로운 세션을 열어 명령을 수행하기 때문에 프로그램이 실행 중인 컨테이너의 경우 프로세스를 종료시키지 않고도 다른 명령을 실행시켜 bash에 접근할 수 있게 된다.
```
docker -it 'CONTAINER ID' '실행 명령'
```
해당 명령어를 사용해 웹서버를 돌리고 있는 컨테이너의 bash에 접근해보자.
![](https://velog.velcdn.com/images/chlrjs132/post/b63e6d8a-04d6-4634-9064-ff52f6d28bf4/image.png)

exec 명령어를 사용해 상호작용 모드로 bash를 실행시켰다. 기존 세션을 유지한 채 새로운 프로세스를 시작했기 때문에 셸 실행이 문제없이 잘 되는 것을 볼 수있고 `exit`명령으로 탈출해도 실행 중인 웹서버에 영향을 미치지 않기 때문에 컨테이너가 종료되지도 않는다.

## 고찰
attach와 exec 명령어를 공부하면서 apache 컨테이너에 attach로 접근 시 생기는 문제에 대해 의문이 들었다. -it를 사용하지 않고 백그라운드로 apache 웹서버를 실행 시에는 아무런 입력이 되지 않고, -it옵션을 사용해 상호작용 모드로 apache 웹서버를 실행할 시 컨테이너가 바로 꺼져버리는걸까?

**요점은 컨테이너 실행 시 실행되는 프로세스에 있었다.**
![](https://velog.velcdn.com/images/chlrjs132/post/639857f6-7598-44d5-bad0-bbabbf13c043/image.png)

여기서 볼 수 있는 "httpd-foreground"라는 COMMAND는 컨테이너가 시작될 때 실행될 명령어로 간단히 말하면 내가 실행한 httpd 이미지는 실행 시 위의 커맨드를 실행해 apache 웹서버를 실행하는 것이다.

**실행시점부터 상호작용을 지원하지 않기 때문에 백그라운드로 실행 후 attach로 컨테이너에 연결 시 해당 컨테이너의 표준 입력이 로컬 터미널로 전달되긴 하나 컨테이너 내부에서 아무런 입력도 할 수 없는 것이다. 즉, apache 서버의 로그를 모니터링하는 것 말고는 아무 것도 할 수 없다.**

따라서 ctrl + c로 탈출 시 서버 프로세스가 종료되어 컨테이너가 종료되게 된다.

-it옵션을 사용해 상호작용 모드로 적용 시 attach로 컨테이너에 접근이 가능하긴 하다. 하지만 접근과 동시에 기존에 실행되고 있던 apache 웹서버는 종료되어 컨테이너가 꺼지게 되는 것이다.

---
## 정리
- OS만 존재하는 컨테이너
    - attach로 접근해도 원활한 동작 가능
    - OS만 존재하는 컨테이너는 실행과 동시에 함께 실행될 커맨드가 존재하지 않음
    - **따라서 -dit옵션을 사용해 상호작용 모드로 실행하는 것이 강제됨**

- bash 이외의 커맨드(프로세스)가 존재하는 컨테이너
    - -it옵션 자체가 필요가 없음(상호작용 모드를 제공조차 안하기 때문)
    - attach로 접근하면 실행 중인 프로세스에 영향이 가기 때문에 사용하면 안됨
    - **exec -it 등을 사용해 새 프로세스를 만들어 접근**

> OS만 존재하는 빈 컨테이너도 exec -it 명령어를 사용할 수 있다.

이번에 docker를 공부하면서 생긴 작은 의문에 대해 이것저것 조사하다 보니 왜 docker를 사용하는 사람들이 exec를 사용하는지도 어느정도 알게 되었다. 나도 편의성으로 인해 exec 명령을 사용해 컨테이너를 관리할 것 같지만 그래도 해당 명령어의 동작 원리를 알고 사용하는 것이 중요하다고 생각해 기록해본다.



