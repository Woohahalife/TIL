# 2024.02.07 TIL

---

# Docker exec & attach
## attach
`attach` 명령어는 컨테이너의 표준 입력, 출력, 오류 스트림을 로컬 터미널과 연결해주는 명령어이다. 좀 더 자세히 설명하자면 해당 명령어를 사용하여 실행 중인 컨테이너에 연결하면 해당 컨테이너의 프로세스에 현재 터미널 세션을 연결한다. **이것은 기존 세션에 대한 새로운 세션을 열지 않고 현재 세션을 사용하여 컨테이너의 상태를 모니터링하고 제어하는 것을 의미**한다.

## exec
`exec` 명령어는 실행 중인 컨테이너에 특정 명령을 실행시키는 명령어이다. 이 명령어를 사용하면 기존 세션은 유지한 채 새로운 세션을 열어 명령을 수행하기 때문에 프로그램이 실행 중인 컨테이너의 경우 프로세스를 종료시키지 않고도 다른 명령을 실행시켜 bash에 접근할 수 있게 된다.


## 동작 방식

`attach`명령어는 기존 세션을 사용해 컨테이너에 접근하므로 백그라운드에 실행되는 프로세스가 존재하는 경우 동작 과정에서 문제가 생긴다. 예를 들어 백그라운드에서 실행되는 apache 웹서버에 attach로 접근 시 컨테이너가 바로 종료된다거나 출력만 받고 입력은 할 수 없다.


![](https://velog.velcdn.com/images/chlrjs132/post/639857f6-7598-44d5-bad0-bbabbf13c043/image.png)

여기서 볼 수 있는 "httpd-foreground"라는 COMMAND는 컨테이너가 시작될 때 실행될 명령어로 간단히 말하면 내가 실행한 httpd 이미지는 실행 시 위의 커맨드를 실행해 apache 웹서버를 실행하는 것이다.

**실행시점부터 상호작용을 지원하지 않기 때문에 백그라운드로 실행 후 attach로 컨테이너에 연결 시 해당 컨테이너의 표준 입력이 로컬 터미널로 전달되긴 하나 컨테이너 내부에서 아무런 입력도 할 수 없는 것이다. 즉, apache 서버의 로그를 모니터링하는 것 말고는 아무 것도 할 수 없다.**

따라서 ctrl + c로 탈출 시 서버 프로세스가 종료되어 컨테이너가 종료되게 된다.

-it옵션을 사용해 상호작용 모드로 적용 시 attach로 컨테이너에 접근이 가능하긴 하다. 하지만 접근과 동시에 기존에 실행되고 있던 apache 웹서버는 종료되어 컨테이너가 꺼지게 되는 것이다.

반대로 OS만 존재하는 컨테이너는 bash로 프로세스 유지가 가능하기 때문에 attach로도 컨테이너와 상호작용을 할 수 있다.

---
## 정리
- OS만 존재하는 컨테이너
  - **attach로 접근해도 원활한 동작 가능**
  - OS만 존재하는 컨테이너는 실행과 동시에 함께 실행될 커맨드가 존재하지 않음
  - **따라서 -dit옵션을 사용해 상호작용 모드로 실행하는 것이 강제됨**

- bash 이외의 커맨드(프로세스)가 존재하는 컨테이너
  - **-it옵션 자체가 필요가 없음(상호작용 모드를 제공조차 안하기 때문)**
  - attach로 접근하면 실행 중인 프로세스에 영향이 가기 때문에 사용하면 안됨
  - **exec -it 등을 사용해 새 프로세스를 만들어 접근**

> OS만 존재하는 빈 컨테이너도 exec -it 명령어를 사용할 수 있다.